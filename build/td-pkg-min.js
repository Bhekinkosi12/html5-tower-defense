var _TD={a:[],init:function(d,f){delete this.init;var e,a={version:"0.1.15",is_debug:!!f,is_paused:true,width:16,height:16,show_monster_life:true,fps:0,exp_fps:24,exp_fps_half:12,exp_fps_quarter:6,exp_fps_eighth:4,stage_data:{},defaultSettings:function(){return{step_time:36,grid_size:32,padding:10,global_speed:0.1}},init:function(c){this.obj_board=a.lang.$e(c);this.canvas=this.obj_board.getElementsByTagName("canvas")[0];if(this.canvas.getContext){this.ctx=this.canvas.getContext("2d");this.monster_type_count=
a.getDefaultMonsterAttributes();this.iframe=0;this.last_iframe_time=(new Date).getTime();this.fps=0;this.start()}},start:function(){clearTimeout(this._st);a.log("Start!");var c=this;this._exp_fps_0=this.exp_fps-0.4;this._exp_fps_1=this.exp_fps+0.4;this.mode="normal";this.eventManager.clear();this.lang.mix(this,this.defaultSettings());this.stage=new a.Stage("stage-main",a.getDefaultStageData("stage_main"));this.canvas.setAttribute("width",this.stage.width);this.canvas.setAttribute("height",this.stage.height);
this.canvas.onmousemove=function(b){b=c.getEventXY.call(c,b);c.hover(b[0],b[1])};this.canvas.onclick=function(b){b=c.getEventXY.call(c,b);c.click(b[0],b[1])};this.is_paused=false;this.stage.start();this.step();return this},checkCheat:function(c){switch(c){case "money+":this.money+=1E6;this.log("cheat success!");break;case "life+":this.life=100;this.log("cheat success!");break;case "life-":this.life=1;this.log("cheat success!");break;case "difficulty+":this.difficulty*=2;this.log("cheat success! difficulty = "+
this.difficulty);break;case "difficulty-":this.difficulty/=2;this.log("cheat success! difficulty = "+this.difficulty)}},step:function(){if(this.is_debug&&_TD&&_TD.cheat){this.checkCheat(_TD.cheat);_TD.cheat=""}if(!this.is_paused){this.iframe++;if(this.iframe%50==0){var c=(new Date).getTime(),b=this.step_time;this.fps=Math.round(5E5/(c-this.last_iframe_time))/10;this.last_iframe_time=c;if(this.fps<this._exp_fps_0&&b>1)b--;else this.fps>this._exp_fps_1&&b++;this.step_time=b}this.iframe%2400==0&&a.gc();
this.stage.step();this.stage.render();var g=this;this._st=setTimeout(function(){g.step()},this.step_time)}},getEventXY:function(c){var b=a.lang.$e("wrapper");return[c.clientX-b.offsetLeft-this.canvas.offsetLeft+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),c.clientY-b.offsetTop-this.canvas.offsetTop+Math.max(document.documentElement.scrollTop,document.body.scrollTop)]},hover:function(c,b){this.eventManager.hover(c,b)},click:function(c,b){this.eventManager.click(c,b)},mouseHand:function(c){this.canvas.style.cursor=
c?"pointer":"default"},log:function(c){this.is_debug&&window.console&&console.log&&console.log(c)},gc:function(){if(window.CollectGarbage){CollectGarbage();setTimeout(CollectGarbage,1)}}};for(e=0;this.a[e];e++)this.a[e](a);delete this.a;a.init(d)}};
_TD.a.push(function(d){d.lang={$e:function(f){return document.getElementById(f)},$c:function(f,e,a){f=document.createElement(f);e=e||{};for(var c in e)f.setAttribute(c,e[c]);a&&a.appendChild(f);return f},strLeft:function(f,e){var a=f.slice(0,e),c=a.replace(/[^\x00-\xff]/g,"**").length;if(c<=e)return a;c-=a.length;switch(c){case 0:return a;case e:return f.slice(0,e>>1);default:a=e-c;c=f.slice(a,e);var b=c.replace(/[\x00-\xff]/g,"").length;return b?f.slice(0,a)+this.arguments.callee(c,b):f.slice(0,
a)}},strLen2:function(f){return f.replace(/[^\x00-\xff]/g,"**").length},each:function(f,e){if(Array.prototype.forEach)f.forEach(e);else for(var a=0,c=f.length;a<c;a++)e(f[a])},any:function(f,e){for(var a=0,c=f.length;a<c;a++)if(e(f[a]))return f[a];return null},shift:function(f,e){for(;f[0];)e(f.shift())},rndSort:function(f){return f.concat().sort(function(){return Math.random()-0.5})},_rndRGB2:function(f){f=f.toString(16);return f.length==2?f:"0"+f},rndRGB:function(){var f=Math.floor(Math.random()*
256),e=Math.floor(Math.random()*256);return"#"+this._rndRGB2(Math.floor(Math.random()*256))+this._rndRGB2(f)+this._rndRGB2(e)},rgb2Arr:function(f){if(f.length!=7)return[0,0,0];var e=f.substr(1,2),a=f.substr(3,2);f=f.substr(3,2);return[parseInt(e,16),parseInt(a,16),parseInt(f,16)]},rndStr:function(f){f=f||16;var e=[],a,c;for(a=0;a<f;a++){c=Math.floor(Math.random()*36);e.push("1234567890abcdefghijklmnopqrstuvwxyz".substr(c,1))}return e.join("")},nullFunc:function(){},arrayEqual:function(f,e){var a,
c=f.length;if(c!=e.length)return false;for(a=0;a<c;a++)if(f[a]!=e[a])return false;return true},mix:function(f,e,a){if(!e||!f)return f;for(var c in e)if(a!==false||!(c in f))f[c]=e[c];return f}}});
_TD.a.push(function(d){d.eventManager={ex:-1,ey:-1,_registers:{},ontypes:["enter","hover","out","click"],current_type:"hover",isOn:function(f){return this.ex!=-1&&this.ey!=-1&&this.ex>f.x&&this.ex<f.x2&&this.ey>f.y&&this.ey<f.y2},_mkElEvtName:function(f,e){return f.id+"::_evt_::"+e},on:function(f,e,a){this._registers[this._mkElEvtName(f,e)]=[f,e,a]},removeEventListener:function(f,e){delete this._registers[this._mkElEvtName(f,e)]},clear:function(){delete this._registers;this._registers={}},step:function(){if(this.current_type){var f,
e,a,c,b,g=this,h=this.ontypes.length,i,j=[];for(f in this._registers){e=this._registers[f];a=e[0];c=e[1];e=e[2];if(a.is_valid){if(a.is_visiable){i=this.isOn(a);if(this.current_type!="click")if(c=="hover"&&a.is_hover&&i){e();this.current_type="hover"}else if(c=="enter"&&!a.is_hover&&i){a.is_hover=true;e();this.current_type="enter"}else{if(c=="out"&&a.is_hover&&!i){a.is_hover=false;e();this.current_type="out"}}else i&&c=="click"&&e()}}else j.push(a)}d.lang.each(j,function(m){for(b=0;b<h;b++)g.removeEventListener(m,
g.ontypes[b])});this.current_type=""}},hover:function(f,e){if(this.current_type!="click"){this.current_type="hover";this.ex=f;this.ey=e}},click:function(f,e){this.current_type="click";this.ex=f;this.ey=e}}});
_TD.a.push(function(d){d.Stage=function(f,e){this.id=f||"stage-"+d.lang.rndStr();this.cfg=e||{};this.width=this.cfg.width||600;this.height=this.cfg.height||540;this.mode="normal";this.state=0;this.acts=[];this.current_act=null;this._step2=d.lang.nullFunc;this._init()};d.Stage.prototype={_init:function(){typeof this.cfg.init=="function"&&this.cfg.init.call(this);if(typeof this.cfg.step2=="function")this._step2=this.cfg.step2},start:function(){this.state=1;d.lang.each(this.acts,function(f){f.start()})},
pause:function(){this.state=2},gameover:function(){this.current_act.gameover()},clear:function(){this.state=3;d.lang.each(this.acts,function(f){f.clear()})},step:function(){if(!(this.state!=1||!this.current_act)){d.eventManager.step();this.current_act.step();this._step2()}},render:function(){this.state==0||this.state==3||!this.current_act||this.current_act.render()},addAct:function(f){this.acts.push(f)},addElement:function(f,e,a){this.current_act&&this.current_act.addElement(f,e,a)}}});
_TD.a.push(function(d){d.Act=function(f,e){this.stage=f;this.id=e||"act-"+d.lang.rndStr();this.state=0;this.scenes=[];this.end_queue=[];this.current_scene=null;this._init()};d.Act.prototype={_init:function(){this.stage.addAct(this)},start:function(){if(this.stage.current_act&&this.stage.current_act.state!=3){this.state=0;this.stage.current_act.queue(this.start)}else{this.state=1;this.stage.current_act=this;d.lang.each(this.scenes,function(f){f.start()})}},pause:function(){this.state=2},end:function(){this.state=
3;for(var f;f=this.end_queue.shift();)f();this.stage.current_act=null},queue:function(f){this.end_queue.push(f)},clear:function(){this.state=3;d.lang.each(this.scenes,function(f){f.clear()})},step:function(){this.state!=1||!this.current_scene||this.current_scene.step()},render:function(){this.state==0||this.state==3||!this.current_scene||this.current_scene.render()},addScene:function(f){this.scenes.push(f)},addElement:function(f,e,a){this.current_scene&&this.current_scene.addElement(f,e,a)},gameover:function(){this.current_scene.gameover()}}});
_TD.a.push(function(d){d.Scene=function(f,e){this.act=f;this.stage=f.stage;this.is_gameover=false;this.id=e||"scene-"+d.lang.rndStr();this.state=0;this.end_queue=[];this._step_elements=[[],[],[]];this._render_elements=[[],[],[],[],[],[],[],[],[],[]];this._init()};d.Scene.prototype={_init:function(){this.act.addScene(this);this.wave=0},start:function(){if(this.act.current_scene&&this.act.current_scene!=this&&this.act.current_scene.state!=3){this.state=0;this.act.current_scene.queue(this.start)}else{this.state=
1;this.act.current_scene=this}},pause:function(){this.state=2},end:function(){this.state=3;for(var f;f=this.end_queue.shift();)f();this.clear();this.act.current_scene=null},clear:function(){d.lang.shift(this._step_elements,function(f){d.lang.shift(f,function(e){e.del()})});d.lang.shift(this._render_elements,function(f){d.lang.shift(f,function(e){e.del()})})},queue:function(f){this.end_queue.push(f)},gameover:function(){if(!this.is_gameover){this.pause();this.is_gameover=true}},step:function(){if(this.state==
1){if(d.life<=0){d.life=0;this.gameover()}var f,e;for(f=0;f<3;f++){e=[];d.lang.shift(this._step_elements[f],function(a){if(a.is_valid){a.is_paused||a.step();e.push(a)}else setTimeout(function(){a=null},500)});this._step_elements[f]=e}}},render:function(){if(!(this.state==0||this.state==3)){var f,e;d.ctx.clearRect(0,0,this.stage.width,this.stage.height);for(f=0;f<10;f++){e=[];d.lang.shift(this._render_elements[f],function(a){if(a.is_valid){a.is_visiable&&a.render();e.push(a)}});this._render_elements[f]=
e}this.is_gameover&&this.panel.gameover_obj.show()}},addElement:function(f,e,a){e=e||f.step_level||1;a=a||f.render_level;this._step_elements[e].push(f);this._render_elements[a].push(f);f.scene=this;f.step_level=e;f.render_level=a}}});
_TD.a.push(function(d){d.Element=function(f,e){this.id=f||"el-"+d.lang.rndStr();this.cfg=e||{};this.is_valid=true;this.is_visiable=typeof e.is_visiable!="undefined"?e.is_visiable:true;this.is_hover=this.is_paused=false;this.x=this.cfg.x||-1;this.y=this.cfg.y||-1;this.width=this.cfg.width||0;this.height=this.cfg.height||0;this.step_level=e.step_level||1;this.render_level=e.render_level;this.on_events=e.on_events||[];this._init()};d.Element.prototype={_init:function(){var f=this,e,a,c;e=0;for(c=this.on_events.length;e<
c;e++){a=this.on_events[e];switch(a){case "enter":this.on("enter",function(){f.onEnter()});break;case "out":this.on("out",function(){f.onOut()});break;case "hover":this.on("hover",function(){f.onHover()});break;case "click":this.on("click",function(){f.onClick()})}}this.caculatePos()},caculatePos:function(){this.cx=this.x+this.width/2;this.cy=this.y+this.height/2;this.x2=this.x+this.width;this.y2=this.y+this.height},start:function(){this.is_paused=false},pause:function(){this.is_paused=true},hide:function(){this.is_visiable=
false;this.onOut()},show:function(){this.is_visiable=true},del:function(){this.is_valid=false},on:function(f,e){d.eventManager.on(this,f,e)},onEnter:d.lang.nullFunc,onOut:d.lang.nullFunc,onHover:d.lang.nullFunc,onClick:d.lang.nullFunc,step:d.lang.nullFunc,render:d.lang.nullFunc,addToScene:function(f,e,a,c){this.scene=f;if(!isNaN(e)){this.step_level=e||this.step_level;this.render_level=a||this.render_level;c&&d.lang.each(c,function(b){f.addElement(b,e,a)});f.addElement(this,e,a)}}}});
_TD.a.push(function(d){function f(b,g){var h=new d.Element(b,g);d.lang.mix(h,c);h._init(g);return h}var e={_init:function(b){b=b||{};this.grid_x=b.grid_x||10;this.grid_y=b.grid_y||10;this.x=b.x||0;this.y=b.y||0;this.width=this.grid_x*d.grid_size;this.height=this.grid_y*d.grid_size;this.x2=this.x+this.width;this.y2=this.y+this.width;this.grids=[];this.entrance=this.exit=null;this.buildings=[];this.monsters=[];this.bullets=[];this.scene=b.scene;this.is_main_map=!!b.is_main_map;this.select_hl=d.MapSelectHighLight(this.id+
"-hl",{map:this});this.select_hl.addToScene(this.scene,1,9);this.selected_building=null;this._wait_clearInvalidElements=20;this._wait_add_monsters=0;this._wait_add_monsters_arr=[];if(this.is_main_map){this.mmm=new f(this.id+"-mmm",{map:this});this.mmm.addToScene(this.scene,1,7)}var g,h=this.grid_x*this.grid_y,i=b.grid_data||[],j;for(g=0;g<h;g++){j=i[g]||{};j.mx=g%this.grid_x;j.my=Math.floor(g/this.grid_x);j.map=this;j.step_level=this.step_level;j.render_level=this.render_level;j=new d.Grid(this.id+
"-grid-"+j.mx+"-"+j.my,j);this.grids.push(j)}if(b.entrance&&b.exit&&!d.lang.arrayEqual(b.entrance,b.exit)){this.entrance=this.getGrid(b.entrance[0],b.entrance[1]);this.entrance.is_entrance=true;this.exit=this.getGrid(b.exit[0],b.exit[1]);this.exit.is_exit=true}var m=this;b.grids_cfg&&d.lang.each(b.grids_cfg,function(k){var l=m.getGrid(k.pos[0],k.pos[1]);if(l){if(!isNaN(k.passable_flag))l.passable_flag=k.passable_flag;if(!isNaN(k.build_flag))l.build_flag=k.build_flag;k.building&&l.addBuilding(k.building)}})},
checkHasWeapon:function(){this.has_weapon=this.anyBuilding(function(b){return b.is_weapon})!=null},getGrid:function(b,g){return this.grids[g*this.grid_x+b]},anyMonster:function(b){return d.lang.any(this.monsters,b)},anyBuilding:function(b){return d.lang.any(this.buildings,b)},anyBullet:function(b){return d.lang.any(this.bullets,b)},eachBuilding:function(b){d.lang.each(this.buildings,b)},eachMonster:function(b){d.lang.each(this.monsters,b)},eachBullet:function(b){d.lang.each(this.bullets,b)},preBuild:function(b){d.mode=
"build";this.pre_building&&this.pre_building.remove();this.pre_building=new d.Building(this.id+"-pre-building-"+d.lang.rndStr(),{type:b,map:this,is_pre_building:true});this.scene.addElement(this.pre_building,1,this.render_level+1)},cancelPreBuild:function(){d.mode="normal";this.pre_building&&this.pre_building.remove()},clearInvalidElements:function(){if(this._wait_clearInvalidElements>0)this._wait_clearInvalidElements--;else{this._wait_clearInvalidElements=20;var b=[];d.lang.shift(this.buildings,
function(g){g.is_valid&&b.push(g)});this.buildings=b;b=[];d.lang.shift(this.monsters,function(g){g.is_valid&&b.push(g)});this.monsters=b;b=[];d.lang.shift(this.bullets,function(g){g.is_valid&&b.push(g)});this.bullets=b}},addMonster:function(b){if(this.entrance){if(typeof b=="number")b=new d.Monster(null,{idx:b,difficulty:d.difficulty,step_level:this.step_level,render_level:this.render_level+2});this.entrance.addMonster(b)}},addMonsters:function(b,g){this._wait_add_monsters=b;this._wait_add_monsters_objidx=
g},addMonsters2:function(b){this._wait_add_monsters_arr=b},checkPassable:function(b,g){var h=this.getGrid(b,g);return h!=null&&h.passable_flag==1&&h.build_flag!=2},step:function(){this.clearInvalidElements();if(this._wait_add_monsters>0){this.addMonster(this._wait_add_monsters_objidx);this._wait_add_monsters--}else if(this._wait_add_monsters_arr.length>0){var b=this._wait_add_monsters_arr.shift();this.addMonsters(b[0],b[1])}},render:function(){var b=d.ctx;b.strokeStyle="#99a";b.lineWidth=1;b.beginPath();
b.strokeRect(this.x+0.5,this.y+0.5,this.width,this.height);b.closePath();b.stroke()},onOut:function(){this.is_main_map&&this.pre_building&&this.pre_building.hide()}};d.Map=function(b,g){g.on_events=["enter","out"];var h=new d.Element(b,g);d.lang.mix(h,e);h._init(g);return h};var a={_init:function(b){this.map=b.map;this.width=d.grid_size+2;this.height=d.grid_size+2;this.is_visiable=false},show:function(b){this.x=b.x;this.y=b.y;this.is_visiable=true},render:function(){var b=d.ctx;b.lineWidth=2;b.strokeStyle=
"#f93";b.beginPath();b.strokeRect(this.x,this.y,this.width-1,this.height-1);b.closePath();b.stroke()}};d.MapSelectHighLight=function(b,g){var h=new d.Element(b,g);d.lang.mix(h,a);h._init(g);return h};var c={_init:function(b){this.map=b.map;this.x1=this.map.x;this.y1=this.map.y;this.x2=this.map.x2+1;this.y2=this.map.y2+1;this.w=this.map.scene.stage.width;this.h=this.map.scene.stage.height;this.w2=this.w-this.x2;this.h2=this.h-this.y2},render:function(){var b=d.ctx;b.fillStyle="#fff";b.beginPath();
b.fillRect(0,0,this.x1,this.h);b.fillRect(0,0,this.w,this.y1);b.fillRect(0,this.y2,this.w,this.h2);b.fillRect(this.x2,0,this.w2,this.h);b.closePath();b.fill()}}});
_TD.a.push(function(d){var f={_init:function(e){e=e||{};this.map=e.map;this.scene=this.map.scene;this.mx=e.mx;this.my=e.my;this.height=this.width=d.grid_size;this.is_entrance=this.is_exit=false;this.build_flag=this.passable_flag=1;this.building=null;this.caculatePos()},caculatePos:function(){this.x=this.map.x+this.mx*d.grid_size;this.y=this.map.y+this.my*d.grid_size;this.x2=this.x+d.grid_size;this.y2=this.y+d.grid_size;this.cx=Math.floor(this.x+d.grid_size/2);this.cy=Math.floor(this.y+d.grid_size/
2)},checkBlock:function(){if(this.is_entrance||this.is_exit)return true;var e,a=this;if(e=(new d.FindWay(this.map.grid_x,this.map.grid_y,this.map.entrance.mx,this.map.entrance.my,this.map.exit.mx,this.map.exit.my,function(c,b){return!(c==a.mx&&b==a.my)&&a.map.checkPassable(c,b)})).is_blocked)this._block_msg=d._t("blocked");else if(e=!!this.map.anyMonster(function(c){return c.chkIfBlocked(a.mx,a.my)}))this._block_msg=d._t("monster_be_blocked");return e},buyBuilding:function(e){var a=d.getDefaultBuildingAttributes(e).cost||
0;if(d.money>=a){d.money-=a;this.addBuilding(e)}else{d.log(d._t("not_enough_money",[a]));this.scene.panel.balloontip.msg(d._t("not_enough_money",[a]),this)}},addBuilding:function(e){this.building&&this.removeBuilding();e=new d.Building("building-"+e+"-"+d.lang.rndStr(),{type:e,step_level:this.step_level,render_level:this.render_level});e.locate(this);this.scene.addElement(e,this.step_level,this.render_level+1);this.map.buildings.push(e);this.building=e;this.build_flag=2;this.map.checkHasWeapon();
this.map.pre_building&&this.map.pre_building.hide()},removeBuilding:function(){if(this.build_flag==2)this.build_flag=1;this.building&&this.building.remove();this.building=null},addMonster:function(e){e.beAddToGrid(this);this.map.monsters.push(e);e.start()},hightLight:function(e){this.map.select_hl[e?"show":"hide"](this)},render:function(){var e=d.ctx,a=this.x+0.5,c=this.y+0.5;if(this.is_hover){e.fillStyle="rgba(255, 255, 200, 0.2)";e.beginPath();e.fillRect(a,c,this.width,this.height);e.closePath();
e.fill()}if(this.passable_flag==0){e.fillStyle="#fcc";e.beginPath();e.fillRect(a,c,this.width,this.height);e.closePath();e.fill()}if(this.is_entrance||this.is_exit){e.lineWidth=1;e.fillStyle="#ccc";e.beginPath();e.fillRect(a,c,this.width,this.height);e.closePath();e.fill();e.strokeStyle="#666";e.fillStyle=this.is_entrance?"#fff":"#666";e.beginPath();e.arc(this.cx,this.cy,d.grid_size*0.325,0,Math.PI*2,true);e.closePath();e.fill();e.stroke()}e.strokeStyle="#eee";e.lineWidth=1;e.beginPath();e.strokeRect(a,
c,this.width,this.height);e.closePath();e.stroke()},onEnter:function(){if(this.map.is_main_map&&d.mode=="build")if(this.build_flag==1){this.map.pre_building.show();this.map.pre_building.locate(this)}else this.map.pre_building.hide();else if(this.map.is_main_map){var e="";if(this.is_entrance)e=d._t("entrance");else if(this.is_exit)e=d._t("exit");else if(this.passable_flag==0)e=d._t("_cant_pass");else if(this.build_flag==0)e=d._t("_cant_build");e&&this.scene.panel.balloontip.msg(e,this)}},onOut:function(){this.scene.panel.balloontip.el==
this&&this.scene.panel.balloontip.hide()},onClick:function(){if(this.scene.state==1)if(d.mode=="build"&&this.map.is_main_map&&!this.building)this.checkBlock()?this.scene.panel.balloontip.msg(this._block_msg,this):this.buyBuilding(this.map.pre_building.type);else if(!this.building&&this.map.selected_building){this.map.selected_building.toggleSelected();this.map.selected_building=null}}};d.Grid=function(e,a){a.on_events=["enter","out","click"];var c=new d.Element(e,a);d.lang.mix(c,f);c._init(a);return c}});
_TD.a.push(function(d){var f={_init:function(a){this.is_selected=false;this.killed=this.level=0;this.target=null;a=a||{};this.map=a.map||null;this.grid=a.grid||null;this.bullet_type=a.bullet_type||1;this.type=a.type;this.speed=a.speed;this.bullet_speed=a.bullet_speed;this.blink=this.is_pre_building=!!a.is_pre_building;this.wait_blink=this._default_wait_blink=20;this.is_weapon=this.type!="wall";a=d.getDefaultBuildingAttributes(this.type);d.lang.mix(this,a);this.range_px=this.range*d.grid_size;this.money=
this.cost;this.caculatePos()},getUpgradeCost:function(){return Math.floor(this.money*0.75)},getSellMoney:function(){return Math.floor(this.money*0.5)||1},toggleSelected:function(){this.is_selected=!this.is_selected;this.grid.hightLight(this.is_selected);var a=this;if(this.is_selected){this.map.eachBuilding(function(c){c.is_selected=c==a});(this.map.is_main_map?this.scene.panel_map:this.scene.map).eachBuilding(function(c){c.is_selected=false;c.grid.hightLight(false)});this.map.selected_building=this;
this.map.is_main_map?this.scene.map.cancelPreBuild():this.scene.map.preBuild(this.type)}else{if(this.map.selected_building==this)this.map.selected_building=null;this.map.is_main_map||this.scene.map.cancelPreBuild()}if(this.map.is_main_map)if(this.map.selected_building){this.scene.panel.btn_upgrade.show();this.scene.panel.btn_sell.show();this.updateBtnDesc()}else{this.scene.panel.btn_upgrade.hide();this.scene.panel.btn_sell.hide()}},updateBtnDesc:function(){this.scene.panel.btn_upgrade.desc=d._t("upgrade",
[d._t("building_name_"+this.type),this.level+1,this.getUpgradeCost()]);this.scene.panel.btn_sell.desc=d._t("sell",[d._t("building_name_"+this.type),this.getSellMoney()])},locate:function(a){this.grid=a;this.map=a.map;this.cx=this.grid.cx;this.cy=this.grid.cy;this.x=this.grid.x;this.y=this.grid.y;this.x2=this.grid.x2;this.y2=this.grid.y2;this.width=this.grid.width;this.height=this.grid.height;this.px=this.x+0.5;this.py=this.y+0.5;this.wait_blink=this._default_wait_blink;this._fire_wait2=this._fire_wait=
Math.floor(Math.max(2/(this.speed*d.global_speed),1))},remove:function(){if(this.grid&&this.grid.building&&this.grid.building==this)this.grid.building=null;this.hide();this.del()},findTaget:function(){if(!(!this.is_weapon||this.is_pre_building||!this.grid)){var a=this.cx,c=this.cy,b=Math.pow(this.range_px,2);if(!(this.target&&this.target.is_valid&&Math.pow(this.target.cx-a,2)+Math.pow(this.target.cy-c,2)<=b))this.target=d.lang.any(d.lang.rndSort(this.map.monsters),function(g){return Math.pow(g.cx-
a,2)+Math.pow(g.cy-c,2)<=b})}},getTargetPosition:function(){if(!this.target){var a=this.map.is_main_map?this.map.entrance:this.grid;return[a.cx,a.cy]}return[this.target.cx,this.target.cy]},fire:function(){if(this.target&&this.target.is_valid)if(this.type=="laser_gun")this.target.beHit(this,this.damage);else{var a=this.muzzle||[this.cx,this.cy];new d.Bullet(null,{building:this,damage:this.damage,target:this.target,speed:this.bullet_speed,x:a[0],y:a[1]})}},tryToFire:function(){if(this.is_weapon&&this.target){this._fire_wait--;
if(!(this._fire_wait>0))if(this._fire_wait<0)this._fire_wait=this._fire_wait2;else this.fire()}},_upgrade2:function(a){this._upgrade_records[a]||(this._upgrade_records[a]=this[a]);var c=this._upgrade_records[a],b="max_"+a,g=this["_upgrade_rule_"+a]||d.default_upgrade_rule;if(!(!c||isNaN(c))){c=g(this.level,c);if(this[b]&&!isNaN(this[b])&&this[b]<c)c=this[b];this._upgrade_records[a]=c;this[a]=Math.floor(c)}},upgrade:function(){if(!this._upgrade_records)this._upgrade_records={};var a=["damage","range",
"speed","life","shield"],c,b=a.length;for(c=0;c<b;c++)this._upgrade2(a[c]);this.level++;this.range_px=this.range*d.grid_size},tryToUpgrade:function(a){var c=this.getUpgradeCost(),b="";if(c>d.money)b=d._t("not_enough_money",[c]);else{d.money-=c;this.money+=c;this.upgrade();b=d._t("upgrade_success",[d._t("building_name_"+this.type),this.level,this.getUpgradeCost()])}this.updateBtnDesc();this.scene.panel.balloontip.msg(b,a)},tryToSell:function(){if(this.is_valid){d.money+=this.getSellMoney();this.grid.removeBuilding();
this.is_valid=false;this.map.selected_building=null;this.map.select_hl.hide();this.map.checkHasWeapon();this.scene.panel.btn_upgrade.hide();this.scene.panel.btn_sell.hide();this.scene.panel.balloontip.hide()}},step:function(){if(this.blink){this.wait_blink--;if(this.wait_blink<-this._default_wait_blink)this.wait_blink=this._default_wait_blink}this.findTaget();this.tryToFire()},render:function(){if(!(!this.is_visiable||this.wait_blink<0)){var a=d.ctx;d.renderBuilding(this);if(this.map.is_main_map&&
(this.is_selected||this.is_pre_building||this.map.show_all_ranges)&&this.is_weapon&&this.range>0&&this.grid){a.lineWidth=1;a.fillStyle="rgba(187, 141, 32, 0.15)";a.strokeStyle="#bb8d20";a.beginPath();a.arc(this.cx,this.cy,this.range_px,0,Math.PI*2,true);a.closePath();a.fill();a.stroke()}if(this.type=="laser_gun"&&this.target&&this.target.is_valid){a.lineWidth=3;a.strokeStyle="rgba(50, 50, 200, 0.5)";a.beginPath();a.moveTo(this.cx,this.cy);a.lineTo(this.target.cx,this.target.cy);a.closePath();a.stroke();
a.lineWidth=1;a.strokeStyle="rgba(150, 150, 255, 0.5)";a.beginPath();a.lineTo(this.cx,this.cy);a.closePath();a.stroke()}}},onEnter:function(){if(!this.is_pre_building){var a="\u5efa\u7b51\u5de5\u4e8b";a=this.map.is_main_map?d._t("building_info"+(this.type=="wall"?"_wall":""),[d._t("building_name_"+this.type),this.level,this.damage,this.speed,this.range,this.killed]):d._t("building_intro_"+this.type,[d.getDefaultBuildingAttributes(this.type).cost]);this.scene.panel.balloontip.msg(a,this.grid)}},onOut:function(){this.scene.panel.balloontip.el==
this.grid&&this.scene.panel.balloontip.hide()},onClick:function(){this.is_pre_building||this.scene.state!=1||this.toggleSelected()}};d.Building=function(a,c){c.on_events=["enter","out","click"];var b=new d.Element(a,c);d.lang.mix(b,f);b._init(c);return b};var e={_init:function(a){a=a||{};this.speed=a.speed;this.damage=a.damage;this.target=a.target;this.cx=a.x;this.cy=a.y;this.r=a.r||Math.max(Math.log(this.damage),2);if(this.r<1)this.r=1;if(this.r>6)this.r=6;this.building=a.building||null;this.map=
a.map||this.building.map;this.type=a.type||1;this.color=a.color||"#000";this.map.bullets.push(this);this.addToScene(this.map.scene,1,6);this.type==1&&this.caculate()},caculate:function(){var a,c,b;c=this.target.cy;var g;a=this.target.cx-this.cx;c=c-this.cy;b=Math.sqrt(Math.pow(a,2)+Math.pow(c,2));g=20*this.speed*d.global_speed;this.vx=a*g/b;this.vy=c*g/b},checkOutOfMap:function(){this.is_valid=!(this.cx<this.map.x||this.cx>this.map.x2||this.cy<this.map.y||this.cy>this.map.y2);return!this.is_valid},
checkHit:function(){var a=this.cx,c=this.cy,b=this.r,g=this.map.anyMonster(function(h){return Math.pow(h.cx-a,2)+Math.pow(h.cy-c,2)<=Math.pow(h.r+b,2)*2});if(g){g.beHit(this.building,this.damage);this.is_valid=false;return true}return false},step:function(){if(!(this.checkOutOfMap()||this.checkHit())){this.cx+=this.vx;this.cy+=this.vy}},render:function(){var a=d.ctx;a.fillStyle=this.color;a.beginPath();a.arc(this.cx,this.cy,this.r,0,Math.PI*2,true);a.closePath();a.fill()}};d.Bullet=function(a,c){var b=
new d.Element(a,c);d.lang.mix(b,e);b._init(c);return b}});
_TD.a.push(function(d){var f={_init:function(a){a=a||{};this.is_monster=true;this.idx=a.idx||1;this.difficulty=a.difficulty||1;var c=d.getDefaultMonsterAttributes(this.idx);this.speed=Math.floor((c.speed+this.difficulty/2)*(Math.random()*0.5+0.75));if(this.speed<1)this.speed=1;if(this.speed>a.max_speed)this.speed=a.max_speed;this.life=this.life0=Math.floor(c.life*(this.difficulty+1)*(Math.random()+0.5)*0.5);if(this.life<1)this.life=this.life0=1;this.shield=Math.floor(c.shield+this.difficulty/2);if(this.shield<
0)this.shield=0;this.damage=Math.floor((c.damage||1)*(Math.random()*0.5+0.75));if(this.damage<1)this.damage=1;this.money=c.money||Math.floor(Math.sqrt((this.speed+this.life)*(this.shield+1)*this.damage));if(this.money<1)this.money=1;this.color=c.color||d.lang.rndRGB();this.r=Math.floor(this.damage*1.2);if(this.r<4)this.r=4;if(this.r>d.grid_size/2-4)this.r=d.grid_size/2-4;this.render=c.render;this.next_grid=this.map=this.grid=null;this.way=[];this.toward=2;this._dy=this._dx=0;this.is_blocked=false},
caculatePos:function(){var a=this.r;this.x=this.cx-a;this.y=this.cy-a;this.x2=this.cx+a;this.y2=this.cy+a},beHit:function(a,c){if(this.is_valid){var b=Math.ceil(c*0.1);c-=this.shield;if(c<=b)c=b;this.life-=c;d.score+=Math.floor(Math.sqrt(c));this.life<=0&&this.beKilled(a);b=this.scene.panel.balloontip;if(b.el==this)b.text=d._t("monster_info",[this.life,this.shield,this.speed,this.damage])}},beKilled:function(a){if(this.is_valid){this.life=0;this.is_valid=false;d.money+=this.money;a.killed++;d.MonsterExplode(this.id+
"-explode",{monster:this})}},arrive:function(){this.grid=this.next_grid;this.next_grid=null;this.checkFinish()},findWay:function(){var a=this,c=new d.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(b,g){return a.map.checkPassable(b,g)});this.way=c.way;delete c},checkFinish:function(){if(this.grid&&this.map&&this.grid==this.map.exit){d.life-=this.damage;d.wave_damage+=this.damage;if(d.life<=0){d.life=0;d.stage.gameover()}else{this.pause();
this.del()}}},beAddToGrid:function(a){this.grid=a;this.map=a.map;this.cx=a.cx;this.cy=a.cy;this.grid.scene.addElement(this)},getToward:function(){if(this.grid&&this.next_grid)if(this.grid.my<this.next_grid.my)this.toward=0;else if(this.grid.mx<this.next_grid.mx)this.toward=1;else if(this.grid.my>this.next_grid.my)this.toward=2;else if(this.grid.mx>this.next_grid.mx)this.toward=3},getNextGrid:function(){if(this.way.length==0||Math.random()<0.1)this.findWay();var a=this.way.shift();if(a&&!this.map.checkPassable(a[0],
a[1])){this.findWay();a=this.way.shift()}if(a)this.next_grid=this.map.getGrid(a[0],a[1])},chkIfBlocked:function(a,c){var b=this;return(new d.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(g,h){return!(g==a&&h==c)&&b.map.checkPassable(g,h)})).is_blocked},beBlocked:function(){if(!this.is_blocked){this.is_blocked=true;d.log("monster be blocked!")}},step:function(){if(!(!this.is_valid||this.is_paused||!this.grid)){if(!this.next_grid){this.getNextGrid();
if(!this.next_grid){this.beBlocked();return}}if(this.cx==this.next_grid.cx&&this.cy==this.next_grid.cy)this.arrive();else{var a=this.next_grid.cx-this.cx,c=this.next_grid.cy-this.cy,b=a<0?-1:1,g=c<0?-1:1,h=this.speed*d.global_speed;if(Math.abs(a)<h&&Math.abs(c)<h){this.cx=this.next_grid.cx;this.cy=this.next_grid.cy;this._dx=h-Math.abs(a);this._dy=h-Math.abs(c)}else{this.cx+=a==0?0:b*(h+this._dx);this.cy+=c==0?0:g*(h+this._dy);this._dy=this._dx=0}}this.caculatePos()}},onEnter:function(){var a,c=this.scene.panel.balloontip;
if(c.el==this){c.hide();c.el=null}else{a=d._t("monster_info",[this.life,this.shield,this.speed,this.damage]);c.msg(a,this)}},onOut:function(){}};d.Monster=function(a,c){c.on_events=["enter","out"];var b=new d.Element(a,c);d.lang.mix(b,f);b._init(c);return b};var e={_init:function(a){a=a||{monster:null};if(a.monster){var c=d.lang.rgb2Arr(a.monster.color);this.cx=a.monster.cx;this.cy=a.monster.cy;this.r=a.monster.r;this.step_level=a.monster.step_level;this.render_level=a.monster.render_level;this.rgb_r=
c[0];this.rgb_g=c[1];this.rgb_b=c[2];this.rgb_a=1;this.wait=this.wait0=d.exp_fps;a.monster.grid.scene.addElement(this);delete a.monster}},step:function(){if(this.is_valid){this.wait--;this.r++;this.is_valid=this.wait>0;this.rgb_a=this.wait/this.wait0}},render:function(){var a=d.ctx;a.fillStyle="rgba("+this.rgb_r+","+this.rgb_g+","+this.rgb_b+","+this.rgb_a+")";a.beginPath();a.arc(this.cx,this.cy,this.r,0,Math.PI*2,true);a.closePath();a.fill()}};d.MonsterExplode=function(a,c){var b=new d.Element(a,
c);d.lang.mix(b,e);b._init(c);return b}});
_TD.a.push(function(d){var f={_init:function(b){b=b||{};this.x=b.x;this.y=b.y;this.scene=b.scene;this.map=b.main_map;b=new d.Map("panel-map",d.lang.mix({x:this.x+b.map.x,y:this.y+b.map.y,scene:this.scene,step_level:this.step_level,render_level:this.render_level},b.map,false));this.addToScene(this.scene,1,7);b.addToScene(this.scene,1,7,b.grids);this.scene.panel_map=b;this.gameover_obj=new d.GameOver("panel-gameover",{panel:this,scene:this.scene,step_level:this.step_level,is_visiable:false,x:0,y:0,
width:this.scene.stage.width,height:this.scene.stage.height,render_level:9});this.balloontip=new d.BalloonTip("panel-balloon-tip",{scene:this.scene,step_level:this.step_level,render_level:9});this.balloontip.addToScene(this.scene,1,9);this.btn_pause=new d.Button("panel-btn-pause",{scene:this.scene,x:this.x,y:this.y+260,text:d._t("button_pause_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){if(this.scene.state==1){this.scene.pause();this.text=d._t("button_continue_text");
this.scene.panel.btn_upgrade.hide();this.scene.panel.btn_sell.hide();this.scene.panel.btn_restart.show()}else if(this.scene.state==2){this.scene.start();this.text=d._t("button_pause_text");this.scene.panel.btn_restart.hide();if(this.scene.map.selected_building){this.scene.panel.btn_upgrade.show();this.scene.panel.btn_sell.show()}}}});this.btn_restart=new d.Button("panel-btn-restart",{scene:this.scene,x:this.x,y:this.y+300,is_visiable:false,text:d._t("button_restart_text"),step_level:this.step_level,
render_level:this.render_level+1,onClick:function(){setTimeout(function(){d.stage.clear();d.is_paused=true;d.start();d.mouseHand(false)},0)}});this.btn_upgrade=new d.Button("panel-btn-upgrade",{scene:this.scene,x:this.x,y:this.y+300,is_visiable:false,text:d._t("button_upgrade_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToUpgrade(this)}});this.btn_sell=new d.Button("panel-btn-sell",{scene:this.scene,x:this.x,y:this.y+340,
is_visiable:false,text:d._t("button_sell_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToSell(this)}})},step:function(){if(d.life_recover){this._life_recover=this._life_recover2=d.life_recover;this._life_recover_wait=this._life_recover_wait2=d.exp_fps*3;d.life_recover=0}if(this._life_recover&&d.iframe%d.exp_fps_eighth==0){d.life++;this._life_recover--}},render:function(){var b=d.ctx;b.textAlign="left";b.textBaseline="top";
b.fillStyle="#000";b.font="normal 12px 'Courier New'";b.beginPath();b.fillText(d._t("panel_money_title")+d.money,this.x,this.y);b.fillText(d._t("panel_score_title")+d.score,this.x,this.y+20);b.fillText(d._t("panel_life_title")+d.life,this.x,this.y+40);b.fillText(d._t("panel_building_title")+this.map.buildings.length,this.x,this.y+60);b.fillText(d._t("panel_monster_title")+this.map.monsters.length,this.x,this.y+80);b.fillText(d._t("wave_info",[this.scene.wave]),this.x,this.y+210);b.closePath();if(this._life_recover_wait){b.fillStyle=
"rgba(255, 0, 0, "+this._life_recover_wait/this._life_recover_wait2+")";b.font="bold 12px 'Verdana'";b.beginPath();b.fillText("+"+this._life_recover2,this.x+60,this.y+40);b.closePath();this._life_recover_wait--}b.textAlign="right";b.fillStyle="#666";b.font="normal 12px 'Courier New'";b.beginPath();b.fillText("version: "+d.version+" | oldj.net",d.stage.width-d.padding,d.stage.height-d.padding*2);b.closePath();b.textAlign="left";b.fillStyle="#666";b.font="normal 12px 'Courier New'";b.beginPath();b.fillText("FPS: "+
d.fps,d.padding,d.stage.height-d.padding*2);b.closePath()}};d.Panel=function(b,g){var h=new d.Element(b,g);d.lang.mix(h,f);h._init(g);return h};var e={_init:function(b){b=b||{};this.scene=b.scene},caculatePos:function(){var b=this.el;this.x=b.cx+0.5;this.y=b.cy+0.5;if(this.x+this.width>this.scene.stage.width-d.padding)this.x-=this.width;this.px=this.x+5;this.py=this.y+4},msg:function(b,g){this.text=b;var h=d.ctx;h.font="normal 12px 'Courier New'";this.width=Math.max(h.measureText(b).width+10,d.lang.strLen2(b)*
6+10);this.height=24;if(g&&g.cx&&g.cy){this.el=g;this.caculatePos();this.show()}},step:function(){if(!this.el||!this.el.is_valid)this.hide();else this.el.is_monster&&this.caculatePos()},render:function(){if(this.el){var b=d.ctx;b.lineWidth=1;b.fillStyle="rgba(255, 255, 0, 0.5)";b.strokeStyle="rgba(222, 222, 0, 0.9)";b.beginPath();b.rect(this.x,this.y,this.width,this.height);b.closePath();b.fill();b.stroke();b.textAlign="left";b.textBaseline="top";b.fillStyle="#000";b.font="normal 12px 'Courier New'";
b.beginPath();b.fillText(this.text,this.px,this.py);b.closePath()}}};d.BalloonTip=function(b,g){var h=new d.Element(b,g);d.lang.mix(h,e);h._init(g);return h};var a={_init:function(b){b=b||{};this.text=b.text;this.onClick=b.onClick||d.lang.nullFunc;this.x=b.x;this.y=b.y;this.width=b.width||80;this.height=b.height||30;this.font_x=this.x+8;this.font_y=this.y+7;this.scene=b.scene;this.desc=b.desc||"";this.addToScene(this.scene,this.step_level,this.render_level);this.caculatePos()},onEnter:function(){d.mouseHand(true);
this.desc&&this.scene.panel.balloontip.msg(this.desc,this)},onOut:function(){d.mouseHand(false);this.scene.panel.balloontip.el==this&&this.scene.panel.balloontip.hide()},render:function(){var b=d.ctx;b.lineWidth=2;b.fillStyle=this.is_hover?"#eee":"#ccc";b.strokeStyle="#999";b.beginPath();b.rect(this.x,this.y,this.width,this.height);b.closePath();b.fill();b.stroke();b.textAlign="left";b.textBaseline="top";b.fillStyle="#000";b.font="normal 12px 'Courier New'";b.beginPath();b.fillText(this.text,this.font_x,
this.font_y);b.closePath();b.fill()}};d.Button=function(b,g){g.on_events=["enter","out","click"];var h=new d.Element(b,g);d.lang.mix(h,a);h._init(g);return h};var c={_init:function(b){this.panel=b.panel;this.scene=b.scene;this.addToScene(this.scene,1,9)},render:function(){this.panel.btn_pause.hide();this.panel.btn_upgrade.hide();this.panel.btn_sell.hide();this.panel.btn_restart.show();var b=d.ctx;b.textAlign="center";b.textBaseline="middle";b.fillStyle="#ccc";b.font="bold 62px 'Verdana'";b.beginPath();
b.fillText("GAME OVER",this.width/2,this.height/2);b.closePath();b.fillStyle="#f00";b.font="bold 60px 'Verdana'";b.beginPath();b.fillText("GAME OVER",this.width/2,this.height/2);b.closePath()}};d.GameOver=function(b,g){var h=new d.Element(b,g);d.lang.mix(h,c);h._init(g);return h};d.recover=function(b){d.life_recover=b;d.log("life recover: "+b)}});
_TD.a.push(function(d){var f=function(){var a=new d.Act(this,"act-1");a=new d.Scene(a,"scene-1");var c=d.getDefaultStageData("scene_endless");this.config=c.config;d.life=this.config.life;d.money=this.config.money;d.score=this.config.score;d.difficulty=this.config.difficulty;d.wave_damage=this.config.wave_damage;var b=new d.Map("main-map",d.lang.mix({scene:a,is_main_map:true,step_level:1,render_level:2},c.map));b.addToScene(a,1,2,b.grids);a.map=b;a.panel=new d.Panel("panel",d.lang.mix({scene:a,main_map:b,
step_level:1,render_level:7},c.panel));this.newWave=c.newWave;this.map=b;this.wait_new_wave=this.config.wait_new_wave},e=function(){var a=this.current_act.current_scene,c=a.wave;if(!(c==0&&!this.map.has_weapon||a.state!=1))if(this.map.monsters.length==0){if(c>0&&this.wait_new_wave==this.config.wait_new_wave-1){var b=0;if(c%10==0)b=10;else if(c%5==0)b=5;if(d.life+b>100)b=100-d.life;b>0&&d.recover(b)}if(this.wait_new_wave>0)this.wait_new_wave--;else{this.wait_new_wave=this.config.wait_new_wave;c++;
a.wave=c;this.newWave({map:this.map,wave:c})}}};d.getDefaultStageData=function(a){return{stage_main:{width:640,height:560,init:f,step2:e},scene_endless:{map:{grid_x:16,grid_y:16,x:d.padding,y:d.padding,entrance:[0,0],exit:[15,15],grids_cfg:[{pos:[3,3],passable_flag:0},{pos:[7,15],build_flag:0},{pos:[4,12],building:"wall"},{pos:[4,13],building:"wall"}]},panel:{x:d.padding*2+d.grid_size*16,y:d.padding,map:{grid_x:3,grid_y:3,x:0,y:110,grids_cfg:[{pos:[0,0],building:"cannon"},{pos:[1,0],building:"LMG"},
{pos:[2,0],building:"HMG"},{pos:[0,1],building:"laser_gun"},{pos:[2,2],building:"wall"}]}},config:{endless:true,wait_new_wave:d.exp_fps*3,difficulty:1,wave:0,max_wave:-1,wave_damage:0,max_monsters_per_wave:100,money:500,score:0,life:100,waves:[[],[[1,0]],[[1,0],[1,1]],[[2,0],[1,1]],[[2,0],[1,1]],[[3,0],[2,1]],[[4,0],[2,1]],[[5,0],[3,1],[1,2]],[[6,0],[4,1],[1,2]],[[7,0],[3,1],[2,2]],[[8,0],[4,1],[3,2]]]},newWave:function(c){c=c||{};var b=c.map;c=c.wave||1;var g=d.wave_damage||0;if(c!=1)if(g==0)d.difficulty*=
c<5?1.05:d.difficulty>30?1.1:1.2;else if(d.wave_damage>=50)d.difficulty*=0.6;else if(d.wave_damage>=30)d.difficulty*=0.7;else if(d.wave_damage>=20)d.difficulty*=0.8;else if(d.wave_damage>=10)d.difficulty*=0.9;else if(c>=10)d.difficulty*=1.05;if(d.difficulty<1)d.difficulty=1;d.log("wave "+c+", last wave damage = "+g+", difficulty = "+d.difficulty);c=this.config.waves[c]||d.makeMonsters(Math.min(Math.floor(Math.pow(c,1.1)),this.config.max_monsters_per_wave));b.addMonsters2(c);d.wave_damage=0}}}[a]||
{}}});
_TD.a.push(function(d){d.default_upgrade_rule=function(f,e){return e*1.2};d.getDefaultBuildingAttributes=function(f){return{wall:{damage:0,range:0,speed:0,bullet_speed:0,life:100,shield:500,cost:5},cannon:{damage:12,range:4,max_range:8,speed:2,bullet_speed:6,life:100,shield:100,cost:300,_upgrade_rule_damage:function(e,a){return a*(e<=10?1.2:1.3)}},LMG:{damage:5,range:5,max_range:10,speed:3,bullet_speed:6,life:100,shield:50,cost:100},HMG:{damage:30,range:3,max_range:5,speed:3,bullet_speed:5,life:100,
shield:200,cost:800,_upgrade_rule_damage:function(e,a){return a*1.3}},laser_gun:{damage:25,range:6,max_range:10,speed:20,life:100,shield:100,cost:2E3}}[f]||{}}});
_TD.a.push(function(d){function f(){if(this.is_valid&&this.grid){var e=d.ctx;e.strokeStyle="#000";e.lineWidth=1;e.fillStyle=this.color;e.beginPath();e.arc(this.cx,this.cy,this.r,0,Math.PI*2,true);e.closePath();e.fill();e.stroke();if(d.show_monster_life){var a=Math.floor(d.grid_size/4),c=a*2-2;e.fillStyle="#000";e.beginPath();e.fillRect(this.cx-a,this.cy-this.r-6,a*2,4);e.closePath();e.fillStyle="#f00";e.beginPath();e.fillRect(this.cx-a+1,this.cy-this.r-5,this.life*c/this.life0,2);e.closePath()}}}
d.getDefaultMonsterAttributes=function(e){var a=[{name:"monster 1",desc:"\u6700\u5f31\u5c0f\u7684\u602a\u7269",speed:3,max_speed:10,life:50,damage:1,shield:0,money:5},{name:"monster 2",desc:"\u7a0d\u5f3a\u4e00\u4e9b\u7684\u5c0f\u602a",speed:6,max_speed:20,life:50,damage:2,shield:1},{name:"monster speed",desc:"\u901f\u5ea6\u8f83\u5feb\u7684\u5c0f\u602a",speed:12,max_speed:30,life:50,damage:3,shield:1},{name:"monster life",desc:"\u751f\u547d\u503c\u5f88\u5f3a\u7684\u5c0f\u602a",speed:5,max_speed:10,
life:500,damage:3,shield:1},{name:"monster shield",desc:"\u9632\u5fa1\u5f88\u5f3a\u7684\u5c0f\u602a",speed:5,max_speed:10,life:50,damage:3,shield:20},{name:"monster damage",desc:"\u4f24\u5bb3\u503c\u5f88\u5927\u7684\u5c0f\u602a",speed:7,max_speed:14,life:50,damage:10,shield:2},{name:"monster speed-life",desc:"\u901f\u5ea6\u3001\u751f\u547d\u90fd\u8f83\u9ad8\u7684\u602a\u7269",speed:15,max_speed:30,life:100,damage:3,shield:3},{name:"monster speed-2",desc:"\u901f\u5ea6\u5f88\u5feb\u7684\u602a\u7269",
speed:30,max_speed:40,life:30,damage:4,shield:1},{name:"monster shield-life",desc:"\u9632\u5fa1\u5f88\u5f3a\u3001\u751f\u547d\u503c\u5f88\u9ad8\u7684\u602a\u7269",speed:3,max_speed:10,life:300,damage:5,shield:15}];if(typeof e=="undefined")return a.length;var c={};d.lang.mix(c,a[e]||a[0]);if(!c.render)c.render=f;return c};d.makeMonsters=function(e,a){var c=[],b=0,g,h,i=d.monster_type_count;if(!a){a=[];for(g=0;g<i;g++)a.push(g)}for(;b<e;){g=e-b;g=Math.min(Math.floor(Math.random()*g)+1,3);h=Math.floor(Math.random()*
i);c.push([g,a[h]]);b+=g}return c}});
_TD.a.push(function(d){function f(a,c,b,g,h,i){var j,m,k,l;if(c==g){g=c;h=h>b?b+i:b-i}else if(b==h){h=b;g=g>c?c+i:c-i}else{h=(b-h)/(c-g);j=b-c*h;k=h*h+1;l=2*(h*(j-b)-c);i=Math.pow(j-b,2)+c*c-Math.pow(i,2);i=Math.pow(l,2)-4*k*i;if(i<0)return[0,0];i=Math.sqrt(i);m=(-l+i)/(2*k);g=g-c>0&&m-c>0||g-c<0&&m-c<0?m:(-l-i)/(2*k);h=h*g+j}a.lineCap="round";a.moveTo(c,b);a.lineTo(g,h);return[g,h]}var e={cannon:function(a,c,b,g,h){b=a.getTargetPosition();c.fillStyle="#393";c.strokeStyle="#000";c.beginPath();c.lineWidth=
1;c.arc(a.cx,a.cy,h-5,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#060";c.beginPath();c.arc(a.cx,a.cy,7,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#000";c.beginPath();c.arc(a.cx,a.cy,3,0,Math.PI*2,true);c.closePath();c.fill();c.lineWidth=3;c.beginPath();c.moveTo(a.cx,a.cy);a.muzzle=f(c,a.cx,a.cy,b[0],b[1],h);c.closePath();c.fill();c.stroke()},LMG:function(a,c,b,g,h){b=a.getTargetPosition();c.fillStyle="#36f";c.strokeStyle="#000";c.beginPath();c.lineWidth=
1;c.arc(a.cx,a.cy,7,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#060";c.beginPath();c.arc(a.cx,a.cy,5,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#000";c.beginPath();c.arc(a.cx,a.cy,3,0,Math.PI*2,true);c.closePath();c.fill();c.lineWidth=2;c.beginPath();c.moveTo(a.cx,a.cy);a.muzzle=f(c,a.cx,a.cy,b[0],b[1],h);c.closePath();c.fill();c.stroke()},HMG:function(a,c,b,g,h){b=a.getTargetPosition();c.fillStyle="#933";c.strokeStyle="#000";c.beginPath();c.lineWidth=1;
c.arc(a.cx,a.cy,h-2,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#630";c.beginPath();c.arc(a.cx,a.cy,h-5,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#000";c.beginPath();c.arc(a.cx,a.cy,4,0,Math.PI*2,true);c.closePath();c.fill();c.lineWidth=5;c.beginPath();c.moveTo(a.cx,a.cy);a.muzzle=f(c,a.cx,a.cy,b[0],b[1],h);c.closePath();c.fill();c.stroke()},wall:function(a,c,b,g,h){c.lineWidth=1;c.fillStyle="#666";c.strokeStyle="#000";c.fillRect(a.cx-h+1,a.cy-h+1,g-1,g-
1);c.beginPath();c.moveTo(a.cx-h+0.5,a.cy-h+0.5);c.lineTo(a.cx-h+0.5,a.cy+h+0.5);c.lineTo(a.cx+h+0.5,a.cy+h+0.5);c.lineTo(a.cx+h+0.5,a.cy-h+0.5);c.lineTo(a.cx-h+0.5,a.cy-h+0.5);c.moveTo(a.cx-h+0.5,a.cy+h+0.5);c.lineTo(a.cx+h+0.5,a.cy-h+0.5);c.moveTo(a.cx-h+0.5,a.cy-h+0.5);c.lineTo(a.cx+h+0.5,a.cy+h+0.5);c.closePath();c.stroke()},laser_gun:function(a,c){c.fillStyle="#f00";c.strokeStyle="#000";c.beginPath();c.lineWidth=1;c.moveTo(a.cx,a.cy-10);c.lineTo(a.cx-8.66,a.cy+5);c.lineTo(a.cx+8.66,a.cy+5);c.lineTo(a.cx,
a.cy-10);c.closePath();c.fill();c.stroke();c.fillStyle="#60f";c.beginPath();c.arc(a.cx,a.cy,7,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.fillStyle="#000";c.beginPath();c.arc(a.cx,a.cy,3,0,Math.PI*2,true);c.closePath();c.fill();c.lineWidth=3;c.beginPath();c.moveTo(a.cx,a.cy);c.closePath();c.fill();c.stroke()}};d.renderBuilding=function(a){(e[a.type]||e.wall)(a,d.ctx,a.map,d.grid_size,d.grid_size/2)}});
_TD.a.push(function(d){d._msg_texts={_cant_build:"\u4e0d\u80fd\u5728\u8fd9\u513f\u4fee\u5efa",_cant_pass:"\u602a\u7269\u4e0d\u80fd\u901a\u8fc7\u8fd9\u513f",entrance:"\u8d77\u70b9",exit:"\u7ec8\u70b9",not_enough_money:"\u91d1\u94b1\u4e0d\u8db3\uff0c\u9700\u8981 $${0}\uff01",wave_info:"\u7b2c ${0} \u6ce2",panel_money_title:"\u91d1\u94b1: ",panel_score_title:"\u79ef\u5206: ",panel_life_title:"\u751f\u547d: ",panel_building_title:"\u5efa\u7b51: ",panel_monster_title:"\u602a\u7269: ",building_name_wall:"\u8def\u969c",
building_name_cannon:"\u70ae\u53f0",building_name_LMG:"\u8f7b\u673a\u67aa",building_name_HMG:"\u91cd\u673a\u67aa",building_name_laser_gun:"\u6fc0\u5149\u70ae",building_info:"${0}: \u7b49\u7ea7 ${1}\uff0c\u653b\u51fb ${2}\uff0c\u901f\u5ea6 ${3}\uff0c\u5c04\u7a0b ${4}\uff0c\u6218\u7ee9 ${5}",building_info_wall:"${0}",building_intro_wall:"\u8def\u969c \u53ef\u4ee5\u963b\u6b62\u602a\u7269\u901a\u8fc7 ($${0})",building_intro_cannon:"\u70ae\u53f0 \u5c04\u7a0b\u3001\u6740\u4f24\u529b\u8f83\u4e3a\u5e73\u8861 ($${0})",
building_intro_LMG:"\u8f7b\u673a\u67aa \u5c04\u7a0b\u8f83\u8fdc\uff0c\u6740\u4f24\u529b\u4e00\u822c ($${0})",building_intro_HMG:"\u91cd\u673a\u67aa \u5feb\u901f\u5c04\u51fb\uff0c\u5a01\u529b\u8f83\u5927\uff0c\u5c04\u7a0b\u4e00\u822c ($${0})",building_intro_laser_gun:"\u6fc0\u5149\u67aa \u4f24\u5bb3\u8f83\u5927\uff0c\u547d\u4e2d\u7387 100% ($${0})",click_to_build:"\u5de6\u952e\u70b9\u51fb\u5efa\u9020 ${0} ($${1})",upgrade:"\u5347\u7ea7 ${0} \u5230 ${1} \u7ea7\uff0c\u9700\u82b1\u8d39 $${2}\u3002",sell:"\u51fa\u552e ${0}\uff0c\u53ef\u83b7\u5f97 $${1}",
upgrade_success:"\u5347\u7ea7\u6210\u529f\uff0c${0} \u5df2\u5347\u7ea7\u5230 ${1} \u7ea7\uff01\u4e0b\u6b21\u5347\u7ea7\u9700\u8981 $${2}\u3002",monster_info:"\u602a\u7269: \u751f\u547d ${0}\uff0c\u9632\u5fa1 ${1}\uff0c\u901f\u5ea6 ${2}\uff0c\u4f24\u5bb3 ${3}",button_upgrade_text:"\u5347\u7ea7",button_sell_text:"\u51fa\u552e",button_start_text:"\u5f00\u59cb",button_restart_text:"\u91cd\u65b0\u5f00\u59cb",button_pause_text:"\u6682\u505c",button_continue_text:"\u7ee7\u7eed",button_pause_desc_0:"\u6e38\u620f\u6682\u505c",
button_pause_desc_1:"\u6e38\u620f\u7ee7\u7eed",blocked:"\u4e0d\u80fd\u5728\u8fd9\u513f\u4fee\u5efa\u5efa\u7b51\uff0c\u8d77\u70b9\u4e0e\u7ec8\u70b9\u4e4b\u95f4\u81f3\u5c11\u8981\u6709\u4e00\u6761\u8def\u53ef\u5230\u8fbe\uff01",monster_be_blocked:"\u4e0d\u80fd\u5728\u8fd9\u513f\u4fee\u5efa\u5efa\u7b51\uff0c\u6709\u602a\u7269\u88ab\u56f4\u8d77\u6765\u4e86\uff01",_:"ERROR"};d._t=d.translate=function(f,e){e=typeof e=="object"&&e.constructor==Array?e:[];var a=this._msg_texts[f]||this._msg_texts._,c,b=e.length;
for(c=0;c<b;c++)a=a.replace("${"+c+"}",e[c]);return a}});
_TD.a.push(function(d){d.FindWay=function(f,e,a,c,b,g,h){this.m=[];this.w=f;this.h=e;this.x1=a;this.y1=c;this.x2=b;this.y2=g;this.way=[];this.len=this.w*this.h;this.is_blocked=this.is_arrived=false;this.fPassable=typeof h=="function"?h:function(){return true};this._init()};d.FindWay.prototype={_init:function(){if(this.x1==this.x2&&this.y1==this.y2){this.is_arrived=true;this.way=[[this.x1,this.y1]]}else{for(var f=0;f<this.len;f++)this.m[f]=-2;this.x=this.x1;this.y=this.y1;this.distance=0;this.current=
[[this.x,this.y]];for(this.setVal(this.x,this.y,0);this.next(););}},getVal:function(f,e){var a=e*this.w+f;return a<this.len?this.m[a]:-1},setVal:function(f,e,a){f=e*this.w+f;if(f>this.len)return false;this.m[f]=a},getNeighborsOf:function(f,e){var a=[];e>0&&a.push([f,e-1]);f<this.w-1&&a.push([f+1,e]);e<this.h-1&&a.push([f,e+1]);f>0&&a.push([f-1,e]);return a},getAllNeighbors:function(){var f=[],e,a,c=this.current.length;for(a=0;a<c;a++){e=this.current[a];e=this.getNeighborsOf(e[0],e[1]);f=f.concat(e)}return f},
findWay:function(){for(var f=this.x2,e=this.y2,a=this.len,c,b,g,h=-1;(f!=this.x1||e!=this.y1)&&h!=0&&this.way.length<a;){this.way.unshift([f,e]);b=this.getNeighborsOf(f,e);c=b.length;f=[];h=-1;for(g=0;g<c;g++){e=this.getVal(b[g][0],b[g][1]);if(!(e<0))if(h<0||h>e)h=e}for(g=0;g<c;g++){e=b[g];h==this.getVal(e[0],e[1])&&f.push(e)}e=f.length;g=e>1?Math.floor(Math.random()*e):0;e=f[g];f=e[0];e=e[1]}},arrive:function(){this.current=[];this.is_arrived=true;this.findWay()},blocked:function(){this.current=
[];this.is_blocked=true},next:function(){var f=this.getAllNeighbors(),e,a=f.length,c=[],b,g,h,i;this.distance++;for(h=0;h<a;h++){e=f[h];b=e[0];g=e[1];if(this.getVal(b,g)==-2){if(this.fPassable(b,g)){i=this.distance;c.push(e)}else i=-1;this.setVal(b,g,i);if(b==this.x2&&g==this.y2){this.arrive();return false}}}if(c.length==0){this.blocked();return false}this.current=c;return true}}});
